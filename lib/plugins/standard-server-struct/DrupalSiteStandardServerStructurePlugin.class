<?php
/**
 * @file Defines the DrupalSiteStandardServerStructurePlugin class.
 */

/**
 * Responsible for setting up some special things for the server.
 * 
 * We keep a folder of symlinks to the current builds of each site, for 
 * convienence. This is usually in the webroot of the server. The builds are
 * often located in a hidden folder.
 * 
 * @ingroup plugins
 */
class DrupalSiteStandardServerStructurePlugin extends GenericPlugin implements EventListener {
  
  public function initialize() {
    $this->events()->registerListener(array(
      EVENT_SITE_BUILD_SERVER_STRUCTURE,
      EVENT_REMOVE_ALL,
      EVENT_UPDATE_PREPARE_SERVER,
      EVENT_SUBSITE_BUILD_CONFIG,
      EVENT_UPDATE_ALL_START,
      EVENT_UPDATE_ALL_FINISH,
    ), $this);
    $this->config()->extendDefaultConfiguration(array(
      CONFIG_SERVER_SITES_DIR => '',
      CONFIG_SERVER_GLOBAL_FLAG_FILE => FALSE,
    ));
  }
  
  public function captureEvent(DtkEvent &$context, $type) {
    switch ($type) {
      case EVENT_SITE_BUILD_SERVER_STRUCTURE:
        if ($context->checkExecution()) {
          $context->setResult($this->initializeServerStructure($context->getSite()));
        }
        break;
      case EVENT_REMOVE_ALL:
        if ($context->checkExecution()) {
          $context->setResult($this->deleteServerStructure($context->getSite()));
        }
        break;
      case EVENT_SUBSITE_BUILD_CONFIG:
        if ($context->checkExecution()) {
          $context->setResult($this->configureSubsite($context->getSubSite()));
        }
        break;
      case EVENT_UPDATE_ALL_START:
        $this->writeToFlagFile(DTK_FILE_FLAG_UPDATE);
        break;
      case EVENT_UPDATE_ALL_FINISH:
        $this->writeToFlagFile(DTK_FILE_FLAG_NOTHING);
        break;
    }
  }
  
  /**
   * Writes the appropriate flag out to the global flag file, if specified.
   * 
   * @param string $token
   *   The flag to write.
   * 
   * @return boolean
   *   TRUE on success, otherwise FALSE.
   */
  private function writeToFlagFile($token) {
    $file = $this->config()->getConfig(CONFIG_SERVER_GLOBAL_FLAG_FILE);
    if (extra_empty($file)) {
      return TRUE;
    }
    if (!is_writable($file)) {
      if (file_exists($file)) { return FALSE; }
      if (!is_writable(dirname($file))) { return FALSE; }
    }
    return file_put_contents($file, $token) !== FALSE;
  }
  
  /**
   * Handles configuration for local sites.
   * 
   * @param DrupalSite $site
   *   A local Drupal site.
   * 
   * @return boolean
   *   TRUE if the site was configured correctly, otherwise FALSE.
   */
  private function initializeLocalStructure(DrupalSite $site) {
    $site->setSetting(SITE_SETTING_DOCROOT, assemble_path($site->getBuildFolder(), 'current'));
    $site->setToken(SITE_TOKEN_DOCROOT, $site->getSetting(SITE_SETTING_DOCROOT));
    return TRUE;
  }
  
  /**
   * Handles configuration for sites.
   * 
   * Local sites are delegated to initializeLocalStructure().
   * 
   * @param DrupalSite $site
   *   The site to configure.
   * 
   * @return boolean
   *   TRUE if the site was configured correctly, otherwise FALSE.
   */
  private function initializeServerStructure(DrupalSite $site) {
    $this->working(STRING_WORKING_CREATE_SERVER_STRUCT);
    if ($site->getSetting(SITE_IS_LOCAL)) {
      return $this->initializeLocalStructure($site);
    }
    $config = $this->getConfig(array(
      CONFIG_SERVER_SITES_DIR
    ));
    if (empty($config)) {
      return FALSE;
    }
    $serverDir = $config[CONFIG_SERVER_SITES_DIR];
    $link = assemble_path($serverDir, $site->getBuildName());
    if (is_link($link)) {
      $this->error(STRING_SERVER_STRUCTURE_ALREADY_EXISTS);
      return FALSE;
    }
    symlink(assemble_path($site->getBuildFolder(), 'current'), $link);
    if (!is_link($link)) {
      $this->error(STRING_SERVER_STRUCTURE_CREATE_FAILURE);
      return FALSE;
    }
    $site->setSetting(SITE_SETTING_DOCROOT, $link);
    $site->setToken(SITE_TOKEN_DOCROOT, $site->getSetting(SITE_SETTING_DOCROOT));
    $this->success(STRING_SUCCESS_CREATE_SERVER_STRUCT);
    return TRUE;
  }
  
  /**
   * Responsible for deleting the server structure.
   * 
   * @param DrupalSite $site
   *   The server structure.
   * 
   * @return boolean
   *   TRUE if the server docroot was removed successfully, otherwise FALSE.
   */
  private function deleteServerStructure(DrupalSite $site) {
    // We don't handle local sites.
    if ($site->getSetting(SITE_IS_LOCAL)) {
      return TRUE;
    }
    $this->working(STRING_WORKING_DELETE_SERVER_STRUCT);
    $path = $site->getSetting(SITE_SETTING_DOCROOT);
    if (!empty($path)) {
      unlink($path);
    }
    $ret = !is_link($path);
    if ($ret) {
      $this->success(STRING_SUCCESS_DELETE_SERVER_STRUCT);
    }
    else {
      $this->failure(STRING_FAILURE_DELETE_SERVER_STRUCT);
    }
    return $ret;
  }

  /**
   * Configures a subsite to have the necessary items from its parent item.
   * 
   * @param DrupalSubSite $subsite
   *   Subsite to configure
   * 
   * @return boolean
   *   TRUE if successful, otherwise FALSE.
   */
  private function configureSubsite(DrupalSubSite $subsite) {    
    $subsite->setSetting(SITE_SETTING_DOCROOT, $subsite->getParentSite()->getSetting(SITE_SETTING_DOCROOT));
    $subsite->setToken(SITE_TOKEN_DOCROOT, $subsite->getParentSite()->getSetting(SITE_SETTING_DOCROOT));
    return TRUE;
  }
  
}