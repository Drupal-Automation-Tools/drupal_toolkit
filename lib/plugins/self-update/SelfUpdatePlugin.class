<?php
/**
 * @file Defines the SelfUpdatePlugin class.
 */

/**
 * Responsible for registering SelfUpdateCommand.
 * 
 * @ingroup plugins
 */
class SelfUpdatePlugin extends GenericPlugin implements EventListener {
  
  public function initialize() {
    $this->events()->registerListener(array(
      EVENT_CORE_REGISTER_COMMANDS,
      EVENT_SELF_UPDATE_CORE,
    ), $this);
  }
  
  public function captureEvent(DtkEvent &$event, $type) {
    switch ($type) {
      case EVENT_SELF_UPDATE_CORE:
        if ($event->checkExecution()) {
          $event->setResult($this->selfUpdate());
        }
        break;
      case EVENT_CORE_REGISTER_COMMANDS:
        $this->router()->addCommand('self-update', new SelfUpdateCommand());
        break;
    }
  }
  
  /**
   * Responsible for updating the core codebase from git.
   * 
   * @return boolean
   *    TRUE if successful, otherwise FALSE.
   */
  private function selfUpdate() {
    $this->working(STRING_WORKING_PULLING_DTK);
    $ret = git_pull(TOOLKIT_ABSOLUTE_ROOT);
    if ($ret) {
      $this->success(STRING_SUCCESS_PULLING_DTK);
    }
    else {
      $this->failure(STRING_FAILURE_PULLING_DTK);
    }
    return $ret;
  }
  
}