<?php
/**
 * @file Defines the DrushBackupPlugin class.
 */

/**
 * String token for when we are unable to backup the database.
 * 
 * @ingroup strings
 */
define('STRING_COULD_NOT_BACKUP_DB', 'drush_backup.error.no-db-backup');

/**
 * String token for when we are unable to delete the DB backup.
 * 
 * @ingroup strings
 */
define('STRING_ERROR_COULD_NOT_DELETE_BACKUP', 'drush_backup.error.delete-backup');

/**
 * Responsible for database backups using drush.
 */
class DrushBackupPlugin extends GenericPlugin implements EventListener {
  
  public function initialize() {
    $this->events()->registerListener(array(
      EVENT_UPDATE_TAKE_BACKUP,
    ), $this);
  }
  
  public function captureEvent(&$context, $eventType) {
    switch ($eventType) {
      case EVENT_UPDATE_TAKE_BACKUP:
        $context->success = $this->drushBackup($context->site);
        $context->stopPropagation = TRUE;
        break;
      case EVENT_DELETE_BUILD:
        if (empty($context->handled) || $context->success) {
          $context->success = $this->deleteBackup($context->site, $context->buildID);
          $context->handled = TRUE;
        }
        break;
    }
  }
  
  public function requiredPlugins() {
    return array('DrupalSitePlugin', 'DrushConfigurationPlugin', 'DatabaseConfigurationPlugin');
  }
  
  private function deleteBackup(DrupalSite $site, $buildID) {
    $backupDirectory = assemble_path($site->getBuildFolder(), 'backups', $buildID);
    remove_directory($backupDirectory);
    if (is_dir($backupDirectory)) {
      $this->error(STRING_ERROR_COULD_NOT_DELETE_BACKUP);
      return FALSE;
    }
    return TRUE;
  }
  
  /**
   * Takes a backup of a site's database using Drush.
   * 
   * @param DrupalSite $site
   *   The site to take a backup of.
   * 
   * @return boolean
   *   Whether or not the backup was successful.
   */
  private function drushBackup(DrupalSite $site) {
    $drushAlias = $site->getSetting(SITE_DRUSH_ALIAS);
    if (empty($drushAlias)) {
      $this->error(STRING_SITE_MISSING_SETTING, array(
        '!key' => SITE_DRUSH_ALIAS,
      ));
      return FALSE;
    }
    $keys = array(
      'default' => 'default',
    ) + $site->getSetting(SITE_DB_CONNECTION_KEYS);
    $backupDirectory = assemble_path($site->getBuildFolder(), 'backups', $site->getSetting(SITE_LAST_BUILD_ID));
    if (!is_dir($backupDirectory)) {
      mkdir($backupDirectory);
    }
    foreach ($keys as $dbkey) {
      $file = assemble_path($backupDirectory, 'default.' . $dbkey . '.sql');
      if (!drush_db_dump($drushAlias, $file, array(
        'database' => $dbkey,
      ))) {
        $this->error(STRING_COULD_NOT_BACKUP_DB);
        return FALSE;
      }
    }
    return TRUE;
  }  
  
}