<?php

class ResetAllDatabasePasswordCommand extends GenericCommand {
  
  public function executeCommand() {
    $e  = new DtkEvent(TRUE);
    $e->setVariable('complete', FALSE);
    $e->setVariable('errored', FALSE);
    $command = dtk_delegate_command_base(array(OPTION_RESET_MANUAL_PASSWORD));
    $siteCommand = $command . ' site-reset-db-password !site';
    $subsiteCommand = $command . ' subsite-reset-db-password !site !subsite';
    $sites = DrupalSite::findSites($this->config());
    $errored = array();
    $this->events()->fireEvent(EVENT_RESET_PASSWORD_ALL_START, $e);
    foreach ($sites as $sitekey => $site) {
      $this->working(STRING_WORKING_RESET_PASSWORD_ALL_SITE, array(
        '!site' => $sitekey,
      ));
      $return = 0;
      execute_system_command($siteCommand, array(
        '!site' => $sitekey,
      ), $out, $return, FALSE);
      if (!extra_empty($return)) {
        $errored[$sitekey] = $sitekey;
      }
      foreach ($site->getSubSites() as $subsiteID) {
        $this->working(STRING_WORKING_RESET_PASSWORD_ALL_SUBSITE, array(
          '!site' => $sitekey,
          '!subsite' => $subsiteID,
        ));
        $return = 0;
        execute_system_command($subsiteCommand, array(
          '!site' => $sitekey,
          '!subsite' => $subsiteID,
        ), $out, $return, FALSE);
        if (!extra_empty($return)) {
          $errored[$sitekey . '::' . $subsiteID] = $sitekey . '::' . $subsiteID;
        }
      }
    }
    $e->setVariable('complete', TRUE);
    $e->setVariable('errored', !empty($errored));
    $this->events()->fireEvent(EVENT_RESET_PASSWORD_ALL_FINISH, $e);
    if (!empty($errored)) {
      foreach ($errored as $key) {
        $this->error(STRING_ERROR_RESET_PASSWORD_ALL_SITE, array(
          '!site' => $key,
        ));
      }
      $this->error(STRING_ERROR_RESET_PASSWORD_ALL_SITES);
      exit(1);
    }
    else {
      $this->success(STRING_SUCCESS_RESET_PASSWORD_ALL_SITES);
    }
  }
  
}
