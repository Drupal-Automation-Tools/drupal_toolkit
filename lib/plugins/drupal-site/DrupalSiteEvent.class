<?php
/**
 * @file Defines the DrupalSiteEvent class.
 */

/**
 * Handles much of the wrapper work around working with site and subsite
 * events.
 */
class DrupalSiteEvent extends DtkEvent {
  
  /**
   * The generic drupal entity being fired by this object.
   * 
   * @var GenericDrupalEntity
   */
  private $site;
    
  /**
   * 
   * @param GenericDrupalEntity $entity
   *   The entity that this event is related.
   * @param boolean $optional
   *   Whether or not this event is optional.
   * @param array $variables
   *   Extra variables.
   */
  public function __construct(GenericDrupalEntity $entity, $optional = FALSE, $variables = array()) {
    parent::__construct($optional, $variables);
    $this->site = $entity;
  }
  
  /**
   * Retrieves the DrupalEntity.
   * 
   * @return GenericDrupalEntity
   *   The generic drupal entity as specified by the constructor.
   */
  public function getEntity() {
    return $this->site;
  }
  
  /**
   * Retrieves an instance of DrupalSite. This returns the parent site for
   * subsites.
   * 
   * @return DrupalSite
   *   The appropriate DrupalSite instance.
   */
  public function getSite() {
    if ($this->site instanceof DrupalSubSite) {
      return $this->site->getParentSite();
    }
    return $this->site;
  }
  
  /**
   * Retrieves an instance of DrupalSubSite.
   * 
   * @return DrupalSubSite
   *   Returns the entity if it's a subsite, otherwise NULL.
   */
  public function getSubSite() {
    if ($this->site instanceof DrupalSubSite) {
      return $this->site;
    }
    return NULL;
  }
  
  /**
   * Fires an event with appropriate handling of error conditions
   * 
   * @param StringManagerInterface $strings
   *   DI for string management.
   * @param OutputManagerInterface $out
   *   DI for output.
   * @param EventManagerInterface $events
   *   DI for event management.
   * @param type $context
   *   A context array with some or all of the following keys:
   *   - entity: An instance of GenericDrupalEntity (required)
   *   - name: The name of the event to fire (required)
   *   - optional: Set to TRUE to make the event optional (eg no handling is not an error).
   *   - variables: An array of additional variables
   *   - error: An error message to display if unsuccessful
   *   - continue: Set to TRUE to prevent the system from dying on a lack
   *     of success
   *   - code: The error code to die() with. Defaults to 1.
   * 
   * @return boolean
   *   TRUE if successful, FALSE if otherwise and continue was set in $context.
   */
  public static function fireSiteEvent(StringManagerInterface $strings, OutputManagerInterface $out, EventManagerInterface $events, $context) {
    $event = new DrupalSiteEvent(
        $context['entity'], 
        isset($context['optional']) ? $context['optional'] : FALSE, 
        isset( $context['variables']) ? $context['variables'] : array()
    );
    $events->fireEvent($context['name'], $event);
    if (!$event->success()) {
      if (!empty($context['error'])) {
        if (empty($context['error args'])) {
          $context['error args'] = array();
        }
        $context['error args'] += array(
          '!event' => $context['name'],
        );
        $out->log($strings->getString($context['error'], $context['error args']), CLOG_ERROR);
      }
      if (!empty($context['continue'])) {
        die(isset($context['code']) ? $context['code'] : 1);
      }
    }
    return $event->success();
  }
  
}