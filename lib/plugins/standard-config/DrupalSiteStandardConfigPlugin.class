<?php
/**
 * @file Defines the DrupalSiteStandardConfigPlugin class.
 */

/**
 * Config setting to specify a prefix for all created URLs.
 * 
 * Usually the non-prefixed versions will be created as well.
 * 
 * @ingroup config
 */
define('CONFIG_SITE_URL_PREFIX', 'site-url-prefix');

/**
 * Config setting to specify a pattern for the primary URL.
 * 
 * @see DrupalSite::replaceTokens().
 * @ingroup config
 */
define('CONFIG_SITE_URL_PATTERN', 'site-url-pattern');

/**
 * Config setting to specify a pattern for a subsite's primary URL.
 */
define('CONFIG_SUBSITE_URL_PATTERN', 'subsite-url-pattern');

/**
 * Argument to provide extra URLs for the site.
 * 
 * @ingroup args
 */
define('ARG_SITE_URLS', 'site-extra-urls');

/**
 * Argument to specify the site's primary URL.
 * 
 * @ingroup args
 */
define('ARG_SITE_URL', 'site-url');

/**
 * Responsible for some basic configuratino settings that everyone is likely
 * to need with this tool.
 */
class DrupalSiteStandardConfigPlugin extends GenericPlugin implements EventListener {
  
  public function initialize() {
    $this->events()->registerListener(array(
      EVENT_SITE_CONFIGURE,
      EVENT_SUBSITE_BUILD_CONFIG,
    ), $this);
  }
  
  public function captureEvent(&$context, $type) {
    switch ($type) {
      case EVENT_SITE_CONFIGURE:
        if ($context->success) {
          $context->success = $this->configureSite($context->site);
        }
        break;
      case EVENT_SUBSITE_BUILD_CONFIG:
        if (empty($context->handled) || $context->success) {
          $context->success = $this->configureSubSite($context->subsite);
        }
        break;
    }
  } 
  
  private function configureSubSite(DrupalSubSite $subsite) {
    $this->addEntityDomains($subsite);
    return TRUE;
  }
  
  /**
   * Retrieves a list of extra URLs.
   * 
   * @return array
   */
  protected function getExtraURLs() {
    $urls = array();
    $fromArg = $this->args()->getOption(ARG_SITE_URLS);
    if (!empty($fromArg)) {
      $urls = array_merge($urls, explode(DEFAULT_SPLIT_CHARACTER, $fromArg));
    }
    return array_unique($urls);
  }
  
  /**
   * Retrieves the primary site URL
   * 
   * @param GenericDrupalEntity $site
   *   The site or subsite we're operating on.
   * 
   * @return string
   *   The primary URL or null if we cannot figure out one.
   */
  private function getSiteURL(GenericDrupalEntity $site) {
    $fromArg = $this->args()->getOption(ARG_SITE_URL);
    if (!empty($fromArg)) {
      return $fromArg;
    }
    $pattern = $this->config()->getConfig(CONFIG_SITE_URL_PATTERN);
    if ($site instanceof DrupalSubSite) {
      $pattern = $this->config()->getConfig(CONFIG_SUBSITE_URL_PATTERN);
    }    
    if (!empty($pattern)) {
      return $site->replaceTokens($pattern);
    }
    return NULL;
  }
  
  /**
   * Retrieves the domain from a URL.
   * 
   * @param string $url
   *   A URL to parse
   * 
   * @return string
   *   The domain name of URL
   */
  private function fetchDomain($url) {
    // domains that don't begin with a protocol are not handled correctly.
    if (strpos($url, '://') === FALSE) {
      $url = 'http://' . $url;
    }
    $pieces = parse_url($url);
    if (isset($pieces['host'])) {
      return $pieces['host'];
    }
    return NULL;
  }
  
  /**
   * Responsible for configuring the site object on load.
   * 
   * @param DrupalSite $site
   *   The site object to configure.
   * 
   * @return boolean
   *   TRUE if the site was configured correctly, otherwise FALSE.
   */
  private function configureSite(DrupalSite $site) {
    $this->addEntityDomains($site);
    return TRUE;
  }
  
  /**
   * Appends all the information needed about the site or subsite in concern
   * of domains and URLs.
   * 
   * @param GenericDrupalEntity $entity
   *   The entity to configure
   */
  private function addEntityDomains(GenericDrupalEntity $entity) {
    $primary = trim($this->getSiteURL($entity));
    $entity->setPrimaryURL($primary);
    $entity->setToken(SITE_TOKEN_PRIMARY_URL, $primary);
    $entity->setToken(SITE_TOKEN_PRIMARY_DOMAIN, $this->fetchDomain($primary));
    $domains = array(
      $this->fetchDomain($primary),
    );
    $prefix = $this->config()->getConfig(CONFIG_SITE_URL_PREFIX);
    if (!empty($prefix)) {
      $prefixedPrimary = $prefix . $primary;
      $entity->addExtraURL($prefixedPrimary);
      $domains[] = $this->fetchDomain($prefixedPrimary);
    }
    foreach ($this->getExtraURLs() as $url) {
      $url = trim($url);
      if ($url !== $primary) {
        $entity->addExtraURL($url);
        $d = $this->fetchDomain($url);
        if (!in_array($d, $domains)) {
          $domains[] = $d;
        }
        if (!empty($prefix)) {
          $entity->addExtraURL($prefix . $url);
          $prefixedDomain = $prefix . $d;
          if (!in_array($prefixedDomain, $domains)) {
            $domains[] = $prefixedDomain;
          }
        }
      }
    }
    $entity->setSetting(SITE_SETTING_ALL_DOMAINS, $domains);
    $entity->setToken(SITE_TOKEN_ALL_DOMAINS, implode(', ', $domains));
    $entity->setToken(SITE_TOKEN_ALL_URLS, implode(', ', $entity->getAllURLs()));
    if ($entity instanceof DrupalSubSite) {
      $parent = $entity->getParentSite();
      $parentDomains = $parent->getSetting(SITE_SETTING_ALL_DOMAINS);
      foreach ($domains as $d) {
        if (!in_array($d, $parentDomains)) {
          $parentDomains[] = $d;
        }
      }
      $parent->setSetting(SITE_SETTING_ALL_DOMAINS, $parentDomains);
      $parent->setToken(SITE_TOKEN_ALL_DOMAINS, implode(', ', $parentDomains));
    }
  }
  
}