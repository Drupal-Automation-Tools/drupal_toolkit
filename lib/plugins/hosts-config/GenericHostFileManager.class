<?php
/**
 * @file Defines the GenericHostFileManager class.
 */

/**
 * Responsible for managing the hosts file of a server.
 */
abstract class GenericHostFileManager implements HostFileManagerInterface {
  
  /**
   * The path to the host file.
   * 
   * @var string
   */
  private $hostfile = '';
  
  /**
   * The physical machine.
   * 
   * @var PhysicalServerInterface
   */
  private $machine = NULL;
  
  /**
   * Whether or not host files should be compacted.
   * 
   * @var boolean
   */
  private $compact = FALSE;
  
  /**
   * Line ending to use.
   * 
   * @var string
   */
  private $lineEnding = PHP_EOL;
  
  /**
   * Constructor.
   * 
   * @param PhysicalServerInterface $server
   *   The physical machine.
   * @param string $hostfile
   *   The location of the host file for this machine.
   */
  public function __construct(PhysicalServerInterface $server, $hostfile, $lineEnding = PHP_EOL) {
    $this->hostfile = $hostfile;
    $this->machine = $server;
    $this->lineEnding = $lineEnding;
  }
  
  public function setCompactHostFile($compact) {
    $this->compact = $compact;
  }
  
  public function machine() {
    return $this->machine;
  }
  
  public function addHostFileEntries(array $map) {
    $contents = $this->machine()->readFile($this->hostfile);
    $defs = hosts_file_parse($contents);
    $remap = array();
    foreach ($map as $host => $ip) {
      $currentIP = hosts_file_ip_lookup($defs, $host);
      if (empty($currentIP) || ($ip !== $currentIP)) {
        if (!isset($remap[$ip])) {
          $remap[$ip] = array();
        }
        $remap[$ip][] = $host;
      }
    }
    foreach ($remap as $ip => $hosts) {
      hosts_file_add($defs, $ip, $hosts);
    }
    if ($this->compact) {
      $defs = hosts_file_compact($defs, TRUE);
    }
    return $this->machine()->writeFile($this->hostfile, hosts_file_build($defs, "\t", " ", $this->lineEnding));
  }
  
  public function addHostFileEntry($host, $ip) {
    return $this->addHostFileEntries(array($host => $ip));
  }
  
  public function cleanHostEntries(array $map) {
    $contents = $this->machine()->readFile($this->hostfile);
    $defs = hosts_file_parse($contents);
    foreach ($map as $host => $ip) {
      hosts_file_remove_hosts($defs, $host, $ip);
    }
    if ($this->compact) {
      hosts_file_compact($defs, TRUE);
    }
    return $this->machine()->writeFile($this->hostfile, hosts_file_build($defs, "\t", " ", $this->lineEnding));
  }
  
}