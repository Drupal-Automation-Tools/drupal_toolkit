<?php
/**
 * @file Defines the RemoteMachine class.
 */

/**
 * Server setting to disable the server.
 * 
 * @ingroup server_settings
 */
define('SERVER_SETTING_DISABLED', 'disabled');

/**
 * Server setting for the remote host.
 * 
 * @ingroup server_settings
 */
define('SERVER_SETTING_HOST', 'host');

/**
 * Server setting for the remote port for SSH.
 * 
 * @ingroup server_settings
 */
define('SERVER_SETTING_PORT', 'port');

/**
 * Server setting for the fingerprint.
 * 
 * @ingroup server_settings
 */
define('SERVER_SETTING_FINGERPRINT', 'fingerprint');

/**
 * Server setting for the connection type.
 * 
 * @see @ref server_connection_types "Server Connection Types"
 * @ingroup server_settings
 */
define('SERVER_SETTING_CONNECTION_TYPE', 'connection');

/**
 * Server setting for the user name.
 * 
 * @ingroup server_settings
 */
define('SERVER_SETTING_USER', 'user');

/**
 * Server setting for the public key file.
 * 
 * @ingroup server_settings
 */
define('SERVER_SETTING_PUBKEY', 'pubkey');

/**
 * Server setting for the private key file.
 * 
 * @ingroup server_settings
 */
define('SERVER_SETTING_PRIVKEY', 'privkey');

/**
 * Server setting for the passphrase.
 * 
 * @ingroup server_settings
 */
define('SERVER_SETTING_PASSPHRASE', 'passphrase');

/**
 * Connection type to use public-private key authentication.
 * 
 * @ingroup server_connection_types
 */
define('SERVER_CONNECTION_PUBKEY', 'pubkey');

/**
 * Implements PhysicalServerInterface for a remote machine that is connected
 * to using the ssh2 family of functions.
 * 
 * For getting/putting files, this class uses the temp directory to store the 
 * files on their way up/down.
 * 
 * @see ssh2_connect()
 */
class RemoteMachine extends GenericMachine {
  
  /**
   * Resource for the SSH2 connection to the remote machine.
   * 
   * @var resource
   */
  private $handle;
  
  public function initialize() {
    if (is_resource($this->handle)) {
      return TRUE;
    }
    if (!extra_empty($this->getSetting(SERVER_SETTING_DISABLED))) {
      return FALSE;
    }
    $this->handle = ssh2_connect($this->getSetting(SERVER_SETTING_HOST), $this->getSetting(SERVER_SETTING_PORT, 22));
    if (empty($this->handle)) {
      $this->handle = NULL;
      return FALSE;
    }
    $fingerprint = ssh2_fingerprint($this->handle, SSH2_FINGERPRINT_MD5 | SSH2_FINGERPRINT_HEX);
    if (strcmp($fingerprint, $this->getSetting(SERVER_SETTING_FINGERPRINT)) !== 0) {
      $this->handle = NULL;
      return FALSE;
    }
    switch ($this->getSetting(SERVER_SETTING_CONNECTION_TYPE)) {
      case SERVER_CONNECTION_PUBKEY:
        if (!ssh2_auth_pubkey_file($this->handle, 
            $this->getSetting(SERVER_SETTING_USER), 
            $this->getSetting(SERVER_SETTING_PUBKEY), 
            $this->getSetting(SERVER_SETTING_PRIVKEY), 
            $this->getSetting(SERVER_SETTING_PASSPHRASE))) {
          $this->handle = NULL;
          return FALSE;
        }
      default:
        $this->handle = NULL;
        return FALSE;
    }
    return TRUE;
  }
  
  public function sleep() {
    if (is_resource($this->handle)) {
      ssh2_exec($this->handle, 'exit');
      unset($this->handle);
    }
  }
  
  public function __destruct() {
    $this->sleep();
  }
  
  public function executeCommand($command, $args, &$out = array(), &$exit = 0) {
    $escapedCommand = escapeshellcmd(str_replace_all($command, $args, 'escapeshellarg'));
    $fullCommand = '(' . $escapedCommand . '); echo -e "\n$?"';
    $stream = ssh2_exec($this->handle, $fullCommand);
    stream_set_blocking($stream, TRUE);
    $output = stream_get_contents($stream);
    fclose($stream);
    $out = explode(PHP_EOL, $output);
    $exit = array_pop($out);
    return reset($out);
  }
  
  public function writeFile($destination, $contents, $mode=0644) {
    $temp = tempnam(sys_get_temp_dir(), 'dtk-up-');
    file_put_contents($temp, $contents);
    $result = ssh2_scp_send($this->handle, $temp, $destination, $mode);
    unlink($temp);
    return $result;
  }
  
  public function readFile($file) {
    $temp = tempnam(sys_get_temp_dir(), 'dtk-down-');
    $result = ssh2_scp_recv($this->handle, $file, $temp);
    $contents = FALSE;
    if ($result) {
      $contents = file_get_contents($temp);
    }
    unlink($temp);
    return $contents;
  }
  
  public function deleteFile($file) {
    // Prevent deletion of the system root.
    if (extra_empty(trim($file, '/\\'))) {
      return FALSE;
    }
    $this->executeCommand('rm -rf !file', array(
      '!file' => $file,
    ), $out, $exit);
    return extra_empty($exit);
  }
  
}