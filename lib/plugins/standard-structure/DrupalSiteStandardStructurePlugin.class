<?php
/**
 * @file Defines the DrupalSiteStandardStructurePlugin class.
 */

/**
 * Site setting for the codebase directory.
 * 
 * @ingroup site_settings
 */
define('SITE_CODEBASE_DIR', 'structure_codebases_dir');

/**
 * Site setting for the sites directory.
 * 
 * @ingroup site_settings
 */
define('SITE_SITES_DIR', 'structure_sites_dir');

/**
 * Fired to allow plugins to extend this process without overridding it.
 * 
 * @ingroup events
 */
define('EVENT_CONTINUE_STANDARD_STRUCTURE', 'standard-structure-continue');

/**
 * Fired to allow plugins to register their own directories with the structure.
 * 
 * @ingroup events
 */
define('EVENT_DISCOVER_STRUCTURE_DIRS', 'discover-structure-dirs');

/**
 * String token for if there is a failure to create a directory.
 * 
 * @ingroup strings
 */
define('STRING_STRUCTURE_DIR_FAILURE', 'standard_structure.error-could-not-create-dir');

/**
 * String token for if we could not remove the build directory.
 * 
 * @ingroup strings
 */
define('STRING_COULD_NOT_REMOVE_BUILD_DIR', 'standard_structure.error.could-not-remove-build');

/**
 * String token for when a site is about to be removed entirely.
 * 
 * @ingroup strings
 */
define('STRING_WORKING_REMOVE_SITE', 'standard_structure.working.remove-site');

/**
 * String token for when a site was entirely removed succcessfully.
 * 
 * @ingroup strings
 */
define('STRING_SUCCESS_REMOVE_SITE', 'standard_structure.success.remove-site');

/**
 * String token for when a new site is about to be built.
 * 
 * @ingroup strings
 */
define('STRING_WORKING_BUILD_STRUCTURE', 'standard_structure.working.build-site');

/**
 * String token for when a new site was built successfully.
 * 
 * @ingroup strings
 */
define('STRING_SUCCESS_BUILD_STRUCTURE', 'standard_structure.success.build-site');

/**
 * Responsible for setting up the structure of a build.
 */
class DrupalSiteStandardStructurePlugin extends GenericPlugin implements EventListener {
  
  public function initialize() {
    $this->events()->registerListener(array(
      EVENT_SITE_BUILD_STRUCTURE,
      EVENT_DISCOVER_STRUCTURE_DIRS,
      EVENT_REMOVE_ALL,
    ), $this);
  }
  
  public function captureEvent(DtkEvent &$context, $type) {
    switch ($type) {
      case EVENT_SITE_BUILD_STRUCTURE:
        if ($context->checkExecution()) {
          $context->setResult($this->buildSite($context->getSite()));
        }
        break;
      case EVENT_REMOVE_ALL:
        if ($context->checkExecution()) {
          $context->setResult($this->deleteSite($context->getSite()));
        }
        break;
      case EVENT_DISCOVER_STRUCTURE_DIRS:
        $context->setVariable('dirs', array_merge(
            $context->getVariable('dirs'),
            $this->dirDiscovery()
        ));
        break;
    }
  }
  
  /**
   * Deletes a site entirely.
   * 
   * @param DrupalSite $site
   *   The site to delete.
   * 
   * @return boolean
   *   TRUE if successful, otherwise FALSE.
   */
  private function deleteSite(DrupalSite $site) {
    $this->working(STRING_WORKING_REMOVE_SITE);
    if (!remove_directory($site->getBuildFolder())) {
      $this->warn(STRING_COULD_NOT_REMOVE_BUILD_DIR);
      return FALSE;
    }
    $this->success(STRING_SUCCESS_REMOVE_SITE);
    return TRUE;
  }
  
  /**
   * Provides a list of default directories for sites.
   * 
   * @return array
   *   An array of folders
   */
  private function dirDiscovery() {
    return array(
      'backups',
      'restored',
      'reverted',
    );
  }
  
  /**
   * Responsible for creating the site structure.
   * 
   * @param DrupalSite $site
   *   The site to build.
   * 
   * @return boolean
   *   TRUE if successful, otherwise FALSE.
   */
  private function buildSite(DrupalSite $site) {
    $this->working(STRING_WORKING_BUILD_STRUCTURE);
    $event = new DtkEvent(FALSE, array(
      'dirs' => array(
        '/',
        'codebases',
        'sites',
      ),
      'codebaseDir' => 'codebases',
      'sitesDir' => 'sites',
    ));
    $this->events()->fireEvent(EVENT_DISCOVER_STRUCTURE_DIRS, $event);
    $root = $site->getBuildFolder();
    foreach ($event->getVariable('dirs') as $dir) {
      $full = assemble_path($root, $dir);
      if (!is_dir($full)) {
        mkdir($full);
        if (!is_dir($full)) {
          $this->error(STRING_STRUCTURE_DIR_FAILURE, array(
            '!dir' => $full,
          ));
          return FALSE;
        }
      }
    }
    $site->setSetting(SITE_CODEBASE_DIR, $event->getVariable('codebaseDir'));
    $site->setSetting(SITE_SITES_DIR, $event->getVariable('sitesDir'));

    $this->success(STRING_SUCCESS_BUILD_STRUCTURE);
    
    $context = new DrupalSiteEvent($site, TRUE);
    $this->events()->fireEvent(EVENT_CONTINUE_STANDARD_STRUCTURE, $context);
    
    return $context->success;
  }
  
}
