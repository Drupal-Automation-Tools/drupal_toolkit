<?php
/**
 * @file Provides the MySqlDBM class.
 */

/**
 * Database management implementation to support MySQL servers.
 * 
 * Supports the following @ref db_settings "host keys":
 * - \c DB_HOST_HOST
 * - \c DB_HOST_PASSWORD
 * - \c DB_HOST_USER
 * 
 * @ingroup db_typedefs
 */
class MySqlDBM extends GenericDBM {
  
  /**
   * Constructs a DBM for MySQL.
   * 
   * @param array $settings
   *   The settings information from the server configuration.
   */
  public function __construct($settings) {
    parent::__construct('mysql', $settings);
  }
  
  public function available() {
    if (!shell_command_available('mysql')) {
      return FALSE;
    }
    return TRUE;
  }
  
  /**
   * Executes a MySQL command using the command line tool.
   * 
   * @param string $query
   *   The query to execute
   * @param string $out
   *   An output variable for the lines of code from the command.
   * 
   * @return boolean
   *   TRUE if the query executed with no errors, otherwise FALSE.
   */
  private function mysqlCommand($query, $out = '') {
    $cmd = 'mysql --host=!host --user=!user';
    if (!extra_empty($this->getSetting('password'))) {
      $cmd .= ' --password=!password';
    }
    $cmd .= ' -e "%query"';
    execute_system_command($cmd, array(
      '!host' => $this->getSetting(DB_HOST_HOST),
      '!user' => $this->getSetting(DB_HOST_USER),
      '!password' => $this->getSetting(DB_HOST_PASSWORD),
      '%query' => $query,
    ), $out, $exit);
    return empty($exit);
  }
  
  private function cleanName($name) {
    return strtolower(preg_replace('`[^A-Za-z0-9]`i', '', $name));
  }
  
  public function sanitizeDatabaseName($database) {
    $database = parent::sanitizeDatabaseName($this->cleanName($database));
    if (strlen($database) > 64) {
      $database = substr($database, 0, 32) . substr($database, -32);
    }
    return $database;
  }
  
  public function sanitizeUsername($username) {
    $username = parent::sanitizeUsername($this->cleanName($username));
    if (strlen($username) > 16) {
      $username = substr($username, 0, 8) . substr($username, -8);
    }
    return $username;
  }
  
  public function deleteUser($username, $host = NULL) {
    $query = 'DROP USER \'!USER\'';
    if (!empty($host)) {
      $query .= '@\'!HOST\'';
    }
    $q = str_replace_all($query, array(
      '!USER' => $username,
      '!HOST' => $host,
    ));
    return $this->mysqlCommand($q);
  }
  
  public function deleteDatabase($dbname) {
    $query = 'DROP DATABASE IF EXISTS !db_name;';
    $q = str_replace_all($query, array(
      '!db_name' => $dbname,
    ));
    return $this->mysqlCommand($q);
  }
  
  public function createDatabase($database, $username = NULL, $password = NULL, $host = NULL) {
    $q = "CREATE DATABASE IF NOT EXISTS !DB;";
    $hosts = array('%');
    if (is_array($host)) {
      $hosts = $host;
    }
    elseif (!empty($host)) {
      $hosts = array($host);
    }
    $replacements = array(
      '!DB' => $database,
      '!USER' => $username,
      '!PASSWORD' => $password,
    );
    if (!empty($username)) {
      $k = 1;
      foreach ($hosts as $h) {
        $q .= " GRANT ALL ON !DB.* TO '!USER'";
        $q .= "@'!HOST".$k."'";
        $replacements['!HOST' . $k] = $h;
        if (!empty($password)) {
          $q .= " IDENTIFIED BY '!PASSWORD'";
        }
        $q .= ";";
        $k++;
      }
    }
    $q .= ' FLUSH PRIVILEGES;';
    $q = str_replace_all($q, $replacements);
    $ret = $this->mysqlCommand($q);
    if (!$ret) {
      $this->deleteDatabase($database);
      $this->deleteUser($username);
    }
    return $ret;
  }
  
}

