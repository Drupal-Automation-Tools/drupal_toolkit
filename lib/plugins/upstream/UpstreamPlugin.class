<?php
/**
 * @file Defines the UpstreamPlugin class.
 */

/**
 * Set this config key to 1 in order to prevent any syncing with an upstream
 * server.
 * 
 * @ingroup config
 */
define('CONFIG_IGNORE_UPSTREAM', 'upstream-db-ignore');

/**
 * Specifies a server type for the upstream server. Used by the server-interaction
 * plugin to load a server definition.
 * 
 * Unlike other server types, only a single server (the last one defined) is used
 * by this server type.
 * 
 * @ingroup server_types
 */
define('SERVER_TYPE_UPSTREAM_SERVER', 'upstream');

/**
 * String token for when there is no upstream server available.
 * 
 * @ingroup strings
 */
define('STRING_MISSING_UPSTREAM_SERVER', 'upstream.error.missing-upstream-server');

/**
 * Event fired to allow other plugins to bring down upstream data.
 * 
 * @ingroup events
 */
define('EVENT_UPSTREAM_PULL', 'pull-upstream-data');

/**
 * String token for when an upstream pull is about to begin.
 * 
 * @ingroup strings
 */
define('STRING_WORKING_PULL_UPSTREAM', 'upstream.working.pull');

/**
 * String token for when an upstream pull is complete.
 * 
 * @ingroup strings
 */
define('STRING_SUCCESS_PULL_UPSTREAM', 'upstream.success.pull');

/**
 * Generic plugin that supports the concept of upstream servers.
 */
class UpstreamPlugin extends GenericPlugin implements EventListener, ServerInteractionDependency {
  
  private $servers;
  
  public function setServerManager(ServerInteractionManagerInterface $servers) {
    $this->servers = $servers;
  }
  
  public function servers() {
    return $this->servers;
  }
  
  public function requiredPlugins() {
    return array(
      'DrupalSitePlugin',
    );
  }
  
  public function initialize() {
    $this->config()->extendDefaultConfiguration(array(
      CONFIG_IGNORE_UPSTREAM => TRUE,
    ));
    $this->events()->registerListener(array(
      EVENT_UPDATE_PRIOR_ACTIONS,
      EVENT_UPDATE_PRIOR_SUBSITE_ACTIONS,
    ), $this);
  }
  
  public function captureEvent(DtkEvent &$context, $eventType) {
    switch ($eventType) {
      case EVENT_UPDATE_PRIOR_SUBSITE_ACTIONS:
      case EVENT_UPDATE_PRIOR_ACTIONS:
        if ($context->checkExecution()) {
          $context->setResult($this->triggerUpstreamPull($context->getEntity()));
        }
        break;
    }
  }
  
  /**
   * Retrieves the upstream server that is in use.
   * 
   * @return PhysicalServerInterface
   *   The upstream server that is in use, or NULL if there is not one.
   */
  private function getUpstreamServer() {
    $servers = $this->servers()->findServers(SERVER_TYPE_UPSTREAM_SERVER, FALSE);
    if (!empty($servers)) {
      return end($servers);
    }
    return NULL;
  }
  
  /**
   * Fires an event that triggers the upstream pull.
   * 
   * @param GenericDrupalEntity $site
   *   The DrupalSite to pull from upstream.
   * 
   * @return boolean
   *   TRUE if upstream pull was successful.
   */
  private function triggerUpstreamPull(GenericDrupalEntity $site) {
    if (!extra_empty($this->config()->getConfig(CONFIG_IGNORE_UPSTREAM))) {
      return TRUE;
    }
    $this->working(STRING_WORKING_PULL_UPSTREAM);
    $server = $this->getUpstreamServer();
    // Bail on the process if there is no upstream server defined.
    if (empty($server)) {
      $this->error(STRING_MISSING_UPSTREAM_SERVER);
      return FALSE;
    }
    $drushAlias = $site->getDrushAlias(TRUE);
    if (empty($drushAlias)) { return FALSE; }
    $event = new UpstreamPullEvent($site, $drushAlias, $server);
    $this->events()->fireEvent(EVENT_UPSTREAM_PULL, $event);
    if ($event->success()) {
      $this->success(STRING_SUCCESS_PULL_UPSTREAM);
    }
    return $event->success();
  }
  
}
